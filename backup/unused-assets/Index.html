<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; padding: 20px; text-align: center; background-color: #f4f7f6; }
      #main { max-width: 400px; margin: 20px auto; background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      h2 { color: #333; }
      select, button, textarea, input[type="text"], input[type="time"], input[type="date"] { width: 100%; padding: 15px; margin: 10px 0; font-size: 16px; border-radius: 8px; box-sizing: border-box; border: 1px solid #ccc; font-family: inherit; }
      textarea { resize: vertical; min-height: 80px; }
      button { cursor: pointer; color: white; border: none; font-weight: bold; }
      button:disabled { background-color: #cccccc; cursor: not-allowed; }
      #btn-checkin { background-color: #28a745; }
      #btn-checkout { background-color: #dc3545; }
      #status { margin-top: 20px; font-weight: bold; min-height: 40px; color: #555; line-height: 1.5; }
      #name { background-color: #f0f0f0; font-weight: bold; text-align: center; }
      label { display: block; margin-top: 15px; font-weight: bold; color: #555; text-align: left; }
    </style>
  </head>
  <body>
    <div id="main">
      <h2>ğŸ“ ì¶œí‡´ê·¼ ê¸°ë¡í•˜ê¸°</h2>
      
      <input type="text" id="name" placeholder="ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘..." readonly>

      <label for="manual-date">ê¸°ë¡ ë‚ ì§œ (ìˆ˜ì • ê°€ëŠ¥)</label>
      <input type="date" id="manual-date">

      <label for="manual-time">ê¸°ë¡ ì‹œê°„ (ìˆ˜ì • ê°€ëŠ¥)</label>
      <input type="time" id="manual-time">

      <label for="reason">ì‚¬ìœ </label>
      <textarea id="reason" placeholder="ì¶œê·¼ ì‹œ ì •í™•í•œ í”„ë¡œì íŠ¸ëª…, ì—…ë¬´ ë‚´ìš© ë“±ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
      
      <button id="btn-checkin" onclick="checkInOrOut('ì¶œê·¼')" disabled>ì¶œê·¼í•˜ê¸°</button>
      <button id="btn-checkout" onclick="checkInOrOut('í‡´ê·¼')" disabled>í‡´ê·¼í•˜ê¸°</button>
      
      <div id="status">ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
    
    <script>
      window.onload = function() {
        google.script.run
          .withSuccessHandler(populateUserInfo)
          .withFailureHandler(handleError)
          .getCurrentUserInfo();
      };
      
      function populateUserInfo(userInfo) {
        const nameInput = document.getElementById('name');
        const checkinBtn = document.getElementById('btn-checkin');
        const checkoutBtn = document.getElementById('btn-checkout');
        const statusDiv = document.getElementById('status');
        const dateInput = document.getElementById('manual-date');
        const timeInput = document.getElementById('manual-time');

        const now = new Date();
        
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;

        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;

        if (userInfo.success) {
          const name = userInfo.name;
          nameInput.value = name;
          checkinBtn.disabled = false;
          checkoutBtn.disabled = false;
          statusDiv.textContent = name + 'ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤. ë‚ ì§œì™€ ì‹œê°„ì„ í™•ì¸í•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        } else {
          nameInput.value = 'ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ì';
          statusDiv.innerHTML = "âŒ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ<br>" + (userInfo.error || "ì§ì› ëª…ë¶€ì— ë“±ë¡ëœ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          dateInput.disabled = true;
          timeInput.disabled = true;
        }
      }

      function checkInOrOut(status) {
        const name = document.getElementById('name').value;
        const reason = document.getElementById('reason').value.trim();
        const manualDate = document.getElementById('manual-date').value;
        const manualTime = document.getElementById('manual-time').value;
        const statusDiv = document.getElementById('status');
        
        if (!name || name === 'ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ì') {
          statusDiv.innerText = "âš ï¸ ìœ íš¨í•œ ì‚¬ìš©ìê°€ ì•„ë‹™ë‹ˆë‹¤.";
          return;
        }

        if (!manualDate || !manualTime) {
            statusDiv.innerText = "âš ï¸ ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }
        
        if (status === 'ì¶œê·¼' && reason === "") {
            statusDiv.innerText = "âš ï¸ ì¶œê·¼ ì‹œì—ëŠ” ì‚¬ìœ ë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }
        
        document.getElementById('btn-checkin').disabled = true;
        document.getElementById('btn-checkout').disabled = true;
        statusDiv.innerText = "â³ ìœ„ì¹˜ ì •ë³´ ìˆ˜ì§‘ ì¤‘... (ë¸Œë¼ìš°ì € ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”)";
        
        const hadDinner = false; // ì €ë…ì‹ì‚¬ ì—¬ë¶€ ì²´í¬ ê¸°ëŠ¥ ì œê±°

        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              statusDiv.innerText = "ğŸ“¡ ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...";
              google.script.run
                .withSuccessHandler(updateStatus)
                .withFailureHandler(handleError)
                .recordAttendance(name, status, reason, manualDate, manualTime, position.coords.latitude, position.coords.longitude, position.coords.accuracy, hadDinner);
            }, 
            () => {
              statusDiv.innerText = "âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ì •ë³´ ì—†ì´ ê¸°ë¡í•©ë‹ˆë‹¤.";
              recordWithoutLocation(name, status, reason, manualDate, manualTime, hadDinner);
            }, 
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          statusDiv.innerText = "âŒ ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
          recordWithoutLocation(name, status, reason, manualDate, manualTime, hadDinner);
        }
      }

      function recordWithoutLocation(name, status, reason, manualDate, manualTime, hadDinner) {
        google.script.run
            .withSuccessHandler(updateStatus)
            .withFailureHandler(handleError)
            .recordAttendance(name, status, reason, manualDate, manualTime, null, null, null, hadDinner);
      }
      
      function updateStatus(message) {
        const statusDiv = document.getElementById('status');
        const mainDiv = document.getElementById('main');
        statusDiv.innerText = message;
        document.getElementById('btn-checkin').disabled = false;
        document.getElementById('btn-checkout').disabled = false;
        
        if (message.startsWith("âœ…")) {
            document.getElementById('reason').value = "";
            mainDiv.style.transition = 'background-color 0.3s';
            mainDiv.style.backgroundColor = '#d4edda';
            setTimeout(() => { mainDiv.style.backgroundColor = 'white'; }, 1500);
        }
      }

      function handleError(error) {
        const statusDiv = document.getElementById('status');
        const mainDiv = document.getElementById('main');
        statusDiv.innerText = 'âŒ ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: ' + error.message;
        document.getElementById('btn-checkin').disabled = false;
        document.getElementById('btn-checkout').disabled = false;
        
        mainDiv.style.transition = 'background-color 0.3s';
        mainDiv.style.backgroundColor = '#f8d7da';
        setTimeout(() => { mainDiv.style.backgroundColor = 'white'; }, 2000);
      }
    </script>
  </body>
</html>
