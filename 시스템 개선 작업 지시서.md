Motion Connect 시스템 개선 작업 지시서
1. 개요
본 문서는 기존 Google Apps Script 기반의 서식 신청/처리 프로세스를 현재의 Next.js 애플리케이션(Motion Connect)으로 통합하고 고도화하기 위한 기술 가이드입니다. 최종 목표는 모든 HR 관련 서식 처리를 중앙화하고, 관리자와 직원의 업무 효율을 극대화하며, 향후 새로운 서식을 코드 수정 없이 추가할 수 있는 유연한 시스템을 구축하는 것입니다.

핵심 개선 방향: 데이터베이스 기반 동적 폼 시스템 구축
기존의 가장 큰 문제점은 새로운 서식을 추가하거나 수정할 때마다 여러 HTML, gs 파일을 수정하고 재배포해야 하는 경직된 구조였습니다. 이를 해결하기 위해, 서식의 구조 자체를 데이터베이스에 저장하고 프론트엔드에서는 이 정보를 동적으로 렌더링하는 아키텍처로 전환합니다.

주요 개발 기능
동적 서식 시스템: 관리자가 데이터베이스에 서식 구조를 정의하면, 시스템이 자동으로 입력 폼을 생성합니다.
자동화된 휴가 워크플로우: 휴가 신청, 승인, 취소 시 휴가일수 차감/복원 및 Google Calendar 연동이 자동으로 처리됩니다.
관리자 기능 강화: 관리자가 직원에게 특별 휴가를 직접 부여하고, 모든 신청 현황을 통합 관리합니다.
알림 시스템: 주요 상태 변경(승인, 거절, 취소) 시 관련자에게 알림을 전송합니다.
2. Phase 1: 기반 시스템 구축 (동적 폼 시스템)
목표: 하드코딩된 폼 로직을 제거하고, 데이터베이스 기반의 유연한 서식 시스템의 토대를 마련합니다.

2.1. 데이터베이스 스키마 확장
새로운 기능을 지원하기 위해 form_templates와 notifications 테이블을 추가합니다.

sql
 Show full code block 
-- 파일: scripts/CLEAN-FINAL-schema.sql (기존 스키마 파일에 추가)

-- ========================================
-- 9단계: 동적 서식 템플릿 테이블 (신규)
-- ========================================
CREATE TABLE public.form_templates (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL UNIQUE, -- 예: "휴가 신청서", "재직증명서"
    description TEXT,
    fields JSONB NOT NULL, -- 폼을 구성하는 필드들의 정의
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ
);

COMMENT ON COLUMN public.form_templates.fields IS '폼 필드 정의. 예: [{"name": "휴가형태", "label": "휴가 형태", "type": "select", "required": true, "options": ["연차", "병가"], "condition": {"field": "...", "operator": "...", "value": "..."}}]';

-- RLS 정책
ALTER TABLE public.form_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "All users can view active form templates"
ON public.form_templates FOR SELECT
USING (is_active = TRUE);

CREATE POLICY "Admins can manage form templates"
ON public.form_templates FOR ALL
USING (auth.uid() IN (SELECT id FROM public.users WHERE role = 'admin'))
WITH CHECK (auth.uid() IN (SELECT id FROM public.users WHERE role = 'admin'));


-- ========================================
-- 10단계: 알림 시스템 테이블 (신규)
-- ========================================
CREATE TABLE public.notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE, -- 알림을 받는 사용자
    message TEXT NOT NULL,
    link TEXT, -- 클릭 시 이동할 경로 (예: /admin/leave-management)
    is_read BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- RLS 정책
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view and manage their own notifications"
ON public.notifications FOR ALL
USING (auth.uid() = user_id);
2.2. 기존 Apps Script 로직 분석 및 데이터 생성
공유해주신 Apps Script 코드를 분석하여, 기존 서식들을 새로운 form_templates 테이블 데이터로 변환합니다. 아래 SQL을 실행하여 초기 서식들을 데이터베이스에 등록합니다.

sql
 Show full code block 
-- 초기 서식 템플릿 데이터 INSERT
INSERT INTO public.form_templates (name, description, fields)
VALUES
(
  '휴가 신청서',
  '연차, 병가, 경조사 등 일반 휴가를 신청합니다.',
  '[
    { "name": "휴가형태", "label": "휴가 형태", "type": "select", "required": true, "options": ["연차", "오전 반차", "오후 반차", "병가", "경조사", "공가", "기타"] },
    { "name": "시작일", "label": "날짜 또는 시작일", "type": "date", "required": true },
    { "name": "종료일", "label": "종료일", "type": "date", "required": true, "condition": { "field": "휴가형태", "operator": "not in", "value": ["오전 반차", "오후 반차"] } },
    { "name": "사유", "label": "사유 (연차/반차 외 필수)", "type": "textarea", "required": false, "condition": { "field": "휴가형태", "operator": "not in", "value": ["연차", "오전 반차", "오후 반차"] } },
    { "name": "전달사항", "label": "전달사항 (업무 인수인계)", "type": "textarea", "required": false },
    { "name": "비상연락처", "label": "비상연락처", "type": "text", "required": false }
  ]'
),
(
  '재직증명서',
  '재직증명서 발급을 신청합니다.',
  '[
    { "name": "제출처", "label": "제출처 (용도)", "type": "text", "required": true }
  ]'
),
(
  '휴직계',
  '개인 사유로 인한 휴직을 신청합니다.',
  '[
    { "name": "휴직형태", "label": "휴직 형태", "type": "select", "required": true, "options": ["무급휴직", "유급휴직", "기타"] },
    { "name": "시작일", "label": "휴직 시작일", "type": "date", "required": true },
    { "name": "종료일", "label": "휴직 종료일", "type": "date", "required": true },
    { "name": "휴직사유", "label": "휴직 사유", "type": "textarea", "required": true }
  ]'
);
-- 참고: '출산휴가 및 육아휴직', '경위서' 등 다른 서식들도 위와 같은 방식으로 추가할 수 있습니다.
2.3. 핵심 컴포넌트 및 API 전환
기존 LeaveApplicationModal을 모든 서식을 처리할 수 있는 범용 모달로 변경하고, 관련 API를 신설/수정합니다.

LeaveApplicationModal.tsx 파일명 변경

src/components/LeaveApplicationModal.tsx -> src/components/FormApplicationModal.tsx
내부 로직은 이미 제안드린 FormApplicationModal.tsx 코드를 참고하여 수정합니다. 이 컴포넌트는 DB에서 템플릿 목록을 불러와 DynamicFormRenderer를 사용해 폼을 동적으로 생성합니다.
범용 서식 제출 API 신설

기존 /api/user/request-leave/route.ts를 대체할 범용 API를 생성합니다.
New file: route.ts
+57
 Show full code block 
import { NextRequest, NextResponse } from 'next/server'
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { calculateLeaveDays } from '@/lib/calculateLeaveDays'

export async function POST(request: NextRequest) {
  const { formType, requestData } = await request.json()
  const supabase = createRouteHandlerClient({ cookies })

  const { data: { session }, } = await supabase.auth.getSession()
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  const userId = session.user.id

  // 휴가 신청일 경우, 잔여 일수 확인 로직 (기존 로직 활용)
  if (formType === '휴가 신청서') {
    const { data: leaveDaysData, error: leaveDaysError } = await supabase
      .from('leave_days')
      .select('leave_types')
      .eq('user_id', userId)
      .single()

    if (leaveDaysError || !leaveDaysData) {
      return NextResponse.json({ error: '휴가 정보를 조회할 수 없습니다.' }, { status: 404 })
    }

    const isHalfDay = requestData.휴가형태?.includes('반차')
    const daysToDeduct = calculateLeaveDays(requestData.시작일, requestData.종료일, isHalfDay)
    const leaveTypes = leaveDaysData.leave_types as any
    const leaveTypeKey = requestData.휴가형태 === '병가' ? 'sick' : 'annual'

    const totalKey = `${leaveTypeKey}_days`
    const usedKey = `used_${leaveTypeKey}_days`
    const remainingDays = (leaveTypes[totalKey] || 0) - (leaveTypes[usedKey] || 0)

    if (remainingDays < daysToDeduct) {
      return NextResponse.json({ error: `잔여 ${requestData.휴가형태}가 부족합니다. (잔여: ${remainingDays}일)` }, { status: 400 })
    }
  }

  // form_requests 테이블에 기록
  const { error: insertError } = await supabase.from('form_requests').insert({
    user_id: userId,
    form_type: formType,
    status: 'pending',
    request_data: requestData,
    submitted_at: new Date().toISOString(),
  })

  if (insertError) {
    console.error('Error inserting form request:', insertError)
    return NextResponse.json({ error: '신청서 저장에 실패했습니다.' }, { status: 500 })
  }

  return NextResponse.json({ success: true, message: 'Request submitted successfully.' })
}
사용자 대시보드 UI 교체

src/app/user/page.tsx에서 기존 Google Apps Script 링크를 여는 버튼들을 제거하고, 새로운 통합 서식 신청 모달을 여는 버튼 하나로 교체합니다.
page.tsx
-7
+13
 Show full code block 
import UserFormManagement from '@/components/UserFormManagement'
import UserWeeklySchedule from '@/components/UserWeeklySchedule'
import UserLeaveStatus from '@/components/UserLeaveStatus'
import FormApplicationModal from '@/components/FormApplicationModal'

interface ReviewLink {
  id: string
  const [isPromotionTarget, setIsPromotionTarget] = useState(false)
  const [reviewLink, setReviewLink] = useState<ReviewLink | null>(null)
  const [showPromotionDetails, setShowPromotionDetails] = useState(false)
  const [isFormModalOpen, setIsFormModalOpen] = useState(false)
  const router = useRouter()

  useEffect(() => {
    }
  }

  const handleLeaveApplication = () => {
    // 휴가 신청서 웹앱 URL
    const leaveFormUrl = 'https://script.google.com/a/motionsense.co.kr/macros/s/AKfycbwnUTLRBpF4gd35Lf07y34jFHsZpgKbTGcwwn5err0Mug9nUYqF0ONWmuntTckSo6Y9/exec?form=vacation'
    window.open(leaveFormUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes')
  }


  return (
    <div className="min-h-screen bg-gray-50">
                  </div>
                  <div className="mt-4 flex flex-wrap gap-3">
                    <button
                      onClick={handleLeaveApplication}
                      onClick={() => setIsFormModalOpen(true)}
                      className="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 flex items-center"
                    >
                      <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        </div>
      </main>

      {/* 통합 서식 신청 모달 */}
      {user && (
        <FormApplicationModal
          user={user}
          isOpen={isFormModalOpen}
          onClose={() => setIsFormModalOpen(false)}
          onSuccess={() => { /* TODO: UserFormManagement 새로고침 로직 연동 */ }}
        />
      )}

      {/* 연차 촉진 상세 안내 모달 */}
      {showPromotionDetails && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
3. Phase 2: 고급 워크플로우 구현
목표: 1단계에서 구축한 기반 위에 휴가 신청/승인/취소 자동화 로직과 관리자 편의 기능을 구현합니다.

3.1. 휴가 승인 자동화
관리자가 '승인' 버튼을 누르면 휴가일수 차감과 캘린더 등록이 원클릭으로 처리되도록 합니다.

핵심 개선: Google Calendar 이벤트의 extendedProperties에 userId, requestId를 저장하여, 이벤트 제목 파싱의 불안정성을 제거하고 보안을 강화합니다.
API 수정: /src/app/api/admin/approve-leave/route.ts의 로직을 아래와 같이 개선합니다.
롤백(Rollback) 로직 추가: DB 업데이트 실패 시, 생성된 캘린더 이벤트를 자동으로 삭제하여 데이터 불일치를 방지합니다.
정확한 휴가일수 계산: 주말/공휴일을 제외하는 calculateLeaveDays 함수를 사용합니다.
알림: 승인 완료 시, 직원에게 알림을 보냅니다.
(기존에 제안드린 /src/app/api/admin/approve-leave/route.ts 코드는 이 개선사항들을 이미 반영하고 있으므로, 해당 코드를 그대로 사용하거나 필요에 맞게 수정하여 적용합니다.)

3.2. 직원 주도 휴가 취소
직원이 직접 휴가를 취소하면, 관련 데이터가 자동으로 복원되고 관리자에게 알림이 갑니다.

API 수정: /src/app/api/user/cancel-leave/route.ts의 로직을 개선합니다.
보안 강화: 이벤트 제목 대신 extendedProperties의 userId를 확인하여 본인만 취소할 수 있도록 합니다.
안정적인 데이터 복원: DB 데이터(휴가일수, 신청상태)를 먼저 복원하고, 성공 시에만 캘린더 이벤트를 삭제합니다.
관리자 알림: notifications 테이블에 취소 내역을 기록합니다.
(기존에 제안드린 /src/app/api/user/cancel-leave/route.ts 코드는 이 개선사항들을 이미 반영하고 있으므로, 해당 코드를 그대로 사용하거나 필요에 맞게 수정하여 적용합니다.)

3.3. 관리자 특별 휴가 지급 기능
관리자가 직원에게 보상휴가, 대체휴가 등을 직접 부여하는 기능입니다.

UI 추가: src/components/AdminEmployeeManagement.tsx의 직원 상세 정보 영역에 '특별휴가 지급' 버튼을 추가합니다.
모달 컴포넌트 생성: GrantSpecialLeaveModal.tsx를 생성합니다.
입력 필드: 휴가 종류 (select: 보상휴가, 대체휴가 등), 일수 (number), 사유 (textarea), 유효기간 (date, 선택)
API 신설: POST /api/admin/grant-leave
로직:
관리자 권한을 확인합니다.
leave_days 테이블의 leave_types JSONB에 special_days 또는 compensatory_days 등의 값을 직접 더해줍니다. (필요시 leave_days 테이블에 관련 필드 추가)
form_requests 테이블에 form_type: '특별휴가 지급', status: 'approved' 상태로 기록을 남겨 추적이 가능하도록 합니다.
직원에게 휴가 지급 알림을 보냅니다.

3.4. 초과근무 신청 및 보상휴가 자동화
토요일, 공휴일 근무에 대한 보상휴가를 체계적으로 관리하고 자동 지급하는 워크플로우를 구축합니다.

#### 3.4.1. 초과근무 신청 서식 추가
`form_templates` 테이블에 '초과근무 신청서'를 추가하여 직원이 신청할 수 있도록 합니다.

```sql
-- 초과근무 신청서 템플릿 데이터 INSERT
INSERT INTO public.form_templates (name, description, fields)
VALUES
(
  '초과근무 신청서',
  '주말 및 공휴일 근무 시 신청합니다. 근무 시간에 따라 대체휴가 또는 보상휴가가 지급됩니다.',
  '[
    { "name": "근무일", "label": "근무일", "type": "date", "required": true },
    { "name": "시작시간", "label": "시작 시간", "type": "time", "required": true },
    { "name": "종료시간", "label": "종료 시간", "type": "time", "required": true },
    { "name": "저녁식사 여부", "label": "저녁 식사 여부 (오후 6시 이후 근무 시)", "type": "select", "options": ["아니오", "예"], "required": true, "condition": { "field": "종료시간", "operator": ">=", "value": "18:00" } },
    { "name": "업무내용", "label": "주요 업무 내용", "type": "textarea", "required": true }
  ]'
);
```

#### 3.4.2. 보상휴가 계산 로직 라이브러리화
초과근무 승인 시 지급될 휴가 시간을 계산하는 로직을 `src/lib/calculateOvertimeLeave.ts`와 같은 별도 파일로 분리하여 관리합니다.

*   **실제 근무시간 계산**: 총 체류 시간에서 기본 휴게시간(1시간)과 저녁식사 여부에 따른 추가 휴게시간(1시간)을 제외하여 계산합니다.
*   **보상휴가 시간 계산 (실제 근무시간 기준)**:
    *   **토요일 (대체휴가)**: 8시간까지는 **1.0배**, 8시간 초과분은 **1.5배** 지급.
    *   **일요일/공휴일 (보상휴가)**: 8시간까지는 **1.5배**, 8시간 초과분은 **2.0배** 지급.

#### 3.4.3. 승인 시 자동 지급 API 로직 강화
관리자가 '초과근무 신청서'를 승인할 때, API가 다음을 자동으로 처리하도록 기존 승인 API 로직을 확장합니다.

*   **API 경로**: `POST /api/admin/approve-request` (기존 승인 API에 `form_type` 분기 처리)
*   **주요 로직**:
    1.  `form_type`이 '초과근무 신청서'인지 확인합니다.
    2.  `calculateOvertimeLeave.ts`를 호출하여 지급할 휴가 시간(시간 단위)을 계산합니다.
    3.  해당 직원의 `leave_days` 테이블 `leave_types` JSONB 필드를 업데이트합니다. (`compensatory_hours`, `reward_hours` 등)
    4.  처리 완료 후, 직원에게 알림을 전송합니다.

#### 3.4.4. 대체휴가 사용 권고 알림
대체휴가(토요일 근무 보상)가 지급될 경우, 직원에게 즉시 사용을 권고하는 특별 알림을 보냅니다.

*   **알림 메시지 예시**: "대체휴가 11시간이 지급되었습니다. 지급된 휴가는 가급적 해당 주에 사용하는 것을 권고드립니다."

4. Phase 3: 최종 전환 및 테스트
목표: 모든 기능을 새 시스템으로 이전하고, 기존 시스템을 비활성화합니다.

기능 통합 테스트:
[ ] 모든 서식이 FormApplicationModal을 통해 정상적으로 신청되는지 확인합니다.
[ ] 휴가 신청 -> 관리자 승인 -> 캘린더 등록 및 일수 차감의 전체 플로우를 테스트합니다.
[ ] 휴가 취소 -> 캘린더 삭제 및 일수 복원, 관리자 알림 플로우를 테스트합니다.
[ ] 관리자의 특별 휴가 지급 기능이 정상 동작하는지 확인합니다.
[ ] 초과근무 신청 -> 관리자 승인 -> 대체/보상휴가 자동 지급 및 알림 플로우를 테스트합니다.
[ ] 지급된 대체/보상휴가가 사용자 휴가 현황 UI에 정상적으로 표시되는지 확인합니다.

기존 시스템 비활성화:
[ ] user/page.tsx에서 모든 Google Apps Script 관련 링크 및 함수(openFormModal, handleFormComplete 등)를 완전히 제거합니다.
[ ] Google Apps Script 프로젝트의 웹 앱 배포를 '나만 액세스'로 변경하거나 중지하여 더 이상 접근할 수 없도록 합니다.
사용자 공지: 새로운 서식 신청 방식에 대해 사용자들에게 공지합니다.
이 지시서를 단계별로 따라가시면, 기존 시스템의 장점은 계승하면서도 훨씬 더 강력하고 유연한 차세대 HR 시스템을 성공적으로 구축하실 수 있을 것입니다.