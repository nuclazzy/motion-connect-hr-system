'use client'

import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabase'

// Assuming a more complete User type
interface Employee {
  id: string
  name: string
  email: string
  department: string
  position: string
  work_type: string
  hire_date: string
  dob: string
  phone: string
  address: string
  is_active: boolean
  resignation_date?: string
  termination_date?: string
  contract_end_date?: string
  annual_leave: number
  sick_leave: number
  substitute_leave_hours: number
  compensatory_leave_hours: number
  // Add other fields as necessary
}

export default function AdminEmployeeManagement() {
  const [employees, setEmployees] = useState<Employee[]>([])
  const [selectedEmployee, setSelectedEmployee] = useState<Employee | null>(null)
  const [formData, setFormData] = useState<Partial<Employee>>({})
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [submitting, setSubmitting] = useState(false)
  const [activeTab, setActiveTab] = useState<'info' | 'leave' | 'management'>('info')
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false)
  const [editingField, setEditingField] = useState<string | null>(null)
  const [editValue, setEditValue] = useState<string>('')
  const [statusFilter, setStatusFilter] = useState<'all' | 'active' | 'resigned' | 'contract'>('all')


  useEffect(() => {
    const fetchData = async () => {
      try {
        console.log('üöÄ Fetching employees (direct Supabase)...')
        
        // localStorageÏóêÏÑú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const userStr = localStorage.getItem('motion-connect-user')
        if (!userStr) {
          throw new Error('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.')
        }
        
        const user = JSON.parse(userStr)
        if (user.role !== 'admin') {
          throw new Error('Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.')
        }

        // SupabaseÏóêÏÑú ÏßÅÏ†ë users ÌÖåÏù¥Î∏î Ï°∞Ìöå (Í∏∞Î≥∏ Ïª¨Îüº Î®ºÏ†Ä ÏãúÎèÑ)
        let { data: users, error } = await supabase
          .from('users')
          .select(`
            id, name, email, department, position, hire_date,
            annual_days, used_annual_days, sick_days, used_sick_days,
            substitute_leave_hours, compensatory_leave_hours
          `)
          .order('hire_date', { ascending: true, nullsFirst: false })

        // termination_date, contract_end_date Ïª¨ÎüºÏù¥ Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Ï∂îÍ∞Ä Ï°∞Ìöå
        let hasStatusColumns = false
        try {
          const { data: usersWithStatus, error: statusError } = await supabase
            .from('users')
            .select(`
              id, name, email, department, position, hire_date,
              annual_days, used_annual_days, sick_days, used_sick_days,
              substitute_leave_hours, compensatory_leave_hours,
              termination_date, contract_end_date
            `)
            .order('hire_date', { ascending: true, nullsFirst: false })
          
          if (!statusError && usersWithStatus) {
            users = usersWithStatus
            hasStatusColumns = true
          }
        } catch (statusErr) {
          console.log('‚ÑπÔ∏è Status columns not found, using basic columns only')
        }

        if (error) {
          console.error('‚ùå Supabase error:', error)
          setError(`ÏßÅÏõê Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§: ${error.message}`)
          return
        }

        console.log('‚úÖ Users fetched directly from Supabase:', users?.length, 'Î™Ö')
        
        // Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò (Ìá¥ÏÇ¨Ïûê Î∞è Í≥ÑÏïΩÏßÅ Î∂ÑÎ•ò Ìè¨Ìï®)
        const result = users?.map((userData: any) => {
          // Ìá¥ÏÇ¨Ïûê Ïó¨Î∂Ä ÌôïÏù∏ (Ïª¨ÎüºÏù¥ ÏûàÎäî Í≤ΩÏö∞Îßå)
          const isTerminated = hasStatusColumns && !!userData.termination_date
          
          // Í≥ÑÏïΩÏßÅ Ïó¨Î∂Ä ÌôïÏù∏ (Ïª¨ÎüºÏù¥ ÏûàÎäî Í≤ΩÏö∞Îßå)
          const isContractEmployee = hasStatusColumns && !!userData.contract_end_date
          
          // Í∑ºÎ¨¥ ÌòïÌÉú Í≤∞Ï†ï
          let work_type = 'Ï†ïÍ∑úÏßÅ'
          if (isTerminated) {
            work_type = 'Ìá¥ÏÇ¨Ïûê'
          } else if (isContractEmployee) {
            work_type = 'Í≥ÑÏïΩÏßÅ'
          }
          
          return {
            ...userData,
            // Í∏∞Î≥∏ ÌïÑÎìúÎì§
            work_type,
            dob: userData.dob || '',
            phone: userData.phone || '',
            address: userData.address || '',
            is_active: !isTerminated, // Ìá¥ÏÇ¨ÏûêÎäî ÎπÑÌôúÏÑ±Ìôî
            resignation_date: userData.resignation_date || null,
            termination_date: userData.termination_date || null,
            contract_end_date: userData.contract_end_date || null,
            updated_at: userData.updated_at || new Date().toISOString(),
            // Ìú¥Í∞Ä Í≥ÑÏÇ∞ ÌïÑÎìúÎì§
            annual_leave: Math.max(0, (userData.annual_days || 0) - (userData.used_annual_days || 0)),
            sick_leave: Math.max(0, (userData.sick_days || 0) - (userData.used_sick_days || 0)),
            substitute_leave_hours: userData.substitute_leave_hours || 0,
            compensatory_leave_hours: userData.compensatory_leave_hours || 0,
            leave_data: {
              annual_days: userData.annual_days || 0,
              used_annual_days: userData.used_annual_days || 0,
              sick_days: userData.sick_days || 0,
              used_sick_days: userData.used_sick_days || 0,
              substitute_leave_hours: userData.substitute_leave_hours || 0,
              compensatory_leave_hours: userData.compensatory_leave_hours || 0
            }
          }
        }) || []
        
        setEmployees(result)
      } catch (err) {
        console.error('‚ùå Error:', err)
        setError(err instanceof Error ? err.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò')
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [])

  // employeesÍ∞Ä Î≥ÄÍ≤ΩÎê† Îïå ÏÑ†ÌÉùÎêú ÏßÅÏõê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (ÏàúÌôò Ï∞∏Ï°∞ Î∞©ÏßÄ)
  useEffect(() => {
    if (selectedEmployee && employees.length > 0) {
      const updatedEmployee = employees.find(emp => emp.id === selectedEmployee.id)
      if (updatedEmployee && JSON.stringify(updatedEmployee) !== JSON.stringify(selectedEmployee)) {
        setSelectedEmployee(updatedEmployee)
      }
    }
  }, [employees]) // selectedEmployeeÎ•º ÏùòÏ°¥ÏÑ±ÏóêÏÑú Ï†úÍ±∞

  // When an employee is selected, populate the form data
  useEffect(() => {
    if (selectedEmployee) {
      setFormData(selectedEmployee)
    } else {
      setFormData({})
    }
  }, [selectedEmployee])

  const handleSelectEmployee = (employee: Employee) => {
    setSelectedEmployee(employee)
  }

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target
    
    let finalValue: string | boolean = value
    if (type === 'checkbox') {
        finalValue = (e.target as HTMLInputElement).checked
    }

    setFormData(prev => ({ ...prev, [name]: finalValue }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!selectedEmployee) return

    setSubmitting(true)
    setError(null)

    try {
      // SupabaseÎ°ú ÏßÅÏ†ë ÏóÖÎç∞Ïù¥Ìä∏
      const { error } = await supabase
        .from('users')
        .update(formData)
        .eq('id', selectedEmployee.id)

      if (error) {
        console.error('‚ùå Supabase update error:', error)
        throw new Error('ÏßÅÏõê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
      }
      
      alert('ÏßÅÏõê Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.')
      // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      setEmployees(prevEmployees => 
        prevEmployees.map(emp => 
          emp.id === selectedEmployee.id ? { ...emp, ...formData } : emp
        )
      )
      setSelectedEmployee({ ...selectedEmployee, ...formData })
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    } finally {
      setSubmitting(false)
    }
  }

  const handleFieldEdit = (fieldKey: string, currentValue: number) => {
    setEditingField(fieldKey)
    setEditValue(currentValue.toString())
  }

  const handleFieldSave = async (fieldKey: string, leaveType: string, adjustmentType: 'granted' | 'used') => {
    const newValue = parseFloat(editValue)
    if (isNaN(newValue) || newValue < 0) {
      alert('Ïú†Ìö®Ìïú Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (0 Ïù¥ÏÉÅ)')
      return
    }

    if (!selectedEmployee) return

    let currentValue = 0
    let difference = 0

    // ÌïÑÎìúÎ≥Ñ ÌòÑÏû¨ Í∞í Í≥ÑÏÇ∞
    if (['substitute_hours', 'compensatory_hours'].includes(fieldKey)) {
      // ÎåÄÏ≤¥Ìú¥Í∞Ä/Î≥¥ÏÉÅÌú¥Í∞ÄÎäî ÏßÅÏ†ë Í∞í ÏÑ§Ï†ï
      currentValue = fieldKey === 'substitute_hours' 
        ? selectedEmployee.substitute_leave_hours || 0
        : selectedEmployee.compensatory_leave_hours || 0
      difference = newValue - currentValue
    } else {
      // Ïó∞Ï∞®/Î≥ëÍ∞ÄÎäî leave_dataÏóêÏÑú Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
      const currentData = (selectedEmployee as any)?.leave_data || {}
      const targetField = leaveType === 'annual_leave' 
        ? (adjustmentType === 'granted' ? 'annual_days' : 'used_annual_days')
        : (adjustmentType === 'granted' ? 'sick_days' : 'used_sick_days')
      
      currentValue = currentData[targetField] || 0
      difference = newValue - currentValue
    }

    // ÏßÅÏ†ë Í∞í ÏÑ§Ï†ïÏù¥ÎØÄÎ°ú Ï∞®Ïù¥Í∞íÏùÑ Ïù¥Ïö©Ìï¥ Ï°∞Ï†ï
    await handleLeaveAdjustment(leaveType, adjustmentType, difference)
    
    setEditingField(null)
    setEditValue('')
  }

  const handleFieldCancel = () => {
    setEditingField(null)
    setEditValue('')
  }

  const handleLeaveAdjustment = async (leaveType: string, adjustmentType: 'granted' | 'used', amount: number) => {
    if (!selectedEmployee) return

    try {
      let updateData: any = {}
      
      if (['substitute_leave_hours', 'compensatory_leave_hours'].includes(leaveType)) {
        // ÎåÄÏ≤¥Ìú¥Í∞Ä/Î≥¥ÏÉÅÌú¥Í∞Ä ÏßÅÏ†ë ÏóÖÎç∞Ïù¥Ìä∏
        const currentValue = leaveType === 'substitute_leave_hours' 
          ? (selectedEmployee.substitute_leave_hours || 0)
          : (selectedEmployee.compensatory_leave_hours || 0)
        
        updateData[leaveType] = currentValue + amount
      } else {
        // Ïó∞Ï∞®/Î≥ëÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏
        const baseType = leaveType === 'annual_leave' ? 'annual' : 'sick'
        const targetField = adjustmentType === 'granted' ? `${baseType}_days` : `used_${baseType}_days`
        
        const currentValue = (selectedEmployee as any).leave_data?.[targetField] || 0
        updateData[targetField] = currentValue + amount
      }

      // SupabaseÎ°ú ÏßÅÏ†ë ÏóÖÎç∞Ïù¥Ìä∏
      const { error } = await supabase
        .from('users')
        .update(updateData)
        .eq('id', selectedEmployee.id)

      if (error) {
        console.error('‚ùå Supabase leave adjustment error:', error)
        throw new Error('Ìú¥Í∞Ä ÏùºÏàò Ï°∞Ï†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
      }
      
      // Î°úÏª¨ ÏÉÅÌÉú Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
      const updatedEmployee = { ...selectedEmployee }
      
      if (['substitute_leave_hours', 'compensatory_leave_hours'].includes(leaveType)) {
        // ÎåÄÏ≤¥Ìú¥Í∞Ä/Î≥¥ÏÉÅÌú¥Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏
        if (leaveType === 'substitute_leave_hours') {
          updatedEmployee.substitute_leave_hours = (selectedEmployee.substitute_leave_hours || 0) + amount
        } else if (leaveType === 'compensatory_leave_hours') {
          updatedEmployee.compensatory_leave_hours = (selectedEmployee.compensatory_leave_hours || 0) + amount
        }
      } else {
        // Ïó∞Ï∞®/Î≥ëÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏
        const leaveData = (updatedEmployee as any).leave_data || {};
        const baseType = leaveType === 'annual_leave' ? 'annual' : 'sick';
        const targetField = adjustmentType === 'granted' ? `${baseType}_days` : `used_${baseType}_days`;
        
        leaveData[targetField] = (leaveData[targetField] || 0) + amount;
        
        // users ÌÖåÏù¥Î∏î ÌïÑÎìúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        (updatedEmployee as any)[targetField] = leaveData[targetField];
        
        // ÏûîÏó¨ ÏùºÏàò Ïû¨Í≥ÑÏÇ∞
        if (leaveType === 'annual_leave') {
          updatedEmployee.annual_leave = (leaveData.annual_days || 0) - (leaveData.used_annual_days || 0);
        } else {
          updatedEmployee.sick_leave = (leaveData.sick_days || 0) - (leaveData.used_sick_days || 0);
        }
        
        (updatedEmployee as any).leave_data = leaveData;
      }
      
      // ÏßÅÏõê Î™©Î°ùÏóêÏÑúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
      setEmployees(prevEmployees => 
        prevEmployees.map(emp => emp.id === updatedEmployee.id ? updatedEmployee : emp)
      )
      setSelectedEmployee(updatedEmployee)
      
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Ìú¥Í∞Ä ÏùºÏàò Ï°∞Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    }
  }

  const handleResignation = async () => {
    if (!selectedEmployee || !formData.resignation_date) return

    setSubmitting(true)
    setError(null)

    try {
      // SupabaseÎ°ú ÏßÅÏ†ë Ìá¥ÏÇ¨ Ï≤òÎ¶¨
      const { error } = await supabase
        .from('users')
        .update({ 
          resignation_date: formData.resignation_date,
          termination_date: formData.resignation_date,
          is_active: false
        })
        .eq('id', selectedEmployee.id)

      if (error) {
        console.error('‚ùå Supabase resignation error:', error)
        throw new Error('Ìá¥ÏÇ¨ Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
      }
      
      alert('Ìá¥ÏÇ¨ Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.')
      
      // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      const updatedEmployee = { 
        ...selectedEmployee, 
        resignation_date: formData.resignation_date,
        termination_date: formData.resignation_date,
        is_active: false
      }
      
      setEmployees(prevEmployees => 
        prevEmployees.map(emp => 
          emp.id === selectedEmployee.id ? updatedEmployee : emp
        )
      )
      setSelectedEmployee(updatedEmployee)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Ìá¥ÏÇ¨ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    } finally {
      setSubmitting(false)
    }
  }

  const handleDeleteEmployee = async () => {
    if (!selectedEmployee) return

    setSubmitting(true)
    setError(null)

    try {
      // SupabaseÎ°ú ÏßÅÏ†ë ÏßÅÏõê ÏÇ≠Ï†ú
      const { error } = await supabase
        .from('users')
        .delete()
        .eq('id', selectedEmployee.id)

      if (error) {
        console.error('‚ùå Supabase delete error:', error)
        throw new Error('ÏßÅÏõê ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
      }
      
      alert('ÏßÅÏõêÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.')
      
      // Î°úÏª¨ ÏÉÅÌÉúÏóêÏÑú ÏßÅÏõê Ï†úÍ±∞
      setEmployees(prevEmployees => 
        prevEmployees.filter(emp => emp.id !== selectedEmployee.id)
      )
      setSelectedEmployee(null)
      setShowDeleteConfirm(false)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ÏßÅÏõê ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    } finally {
      setSubmitting(false)
    }
  }

  // ÏÉÅÌÉúÎ≥Ñ ÏßÅÏõê ÌïÑÌÑ∞ÎßÅ (termination_date Í∏∞Ï§Ä)
  const getFilteredEmployees = () => {
    switch (statusFilter) {
      case 'active':
        return employees.filter(emp => !emp.termination_date && !emp.contract_end_date)
      case 'resigned':
        return employees.filter(emp => !!emp.termination_date)
      case 'contract':
        return employees.filter(emp => !!emp.contract_end_date && !emp.termination_date)
      default:
        return employees
    }
  }

  const filteredEmployees = getFilteredEmployees()

  if (loading) return (
    <div className="p-8 text-center">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto mb-4"></div>
      <p className="text-gray-600">ÏßÅÏõê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
    </div>
  )
  
  if (error && !employees.length) return (
    <div className="p-8 text-center">
      <div className="bg-red-50 border border-red-300 rounded-lg p-6">
        <div className="text-red-600 font-semibold mb-2">‚ùå Ïò§Î•ò Î∞úÏÉù</div>
        <p className="text-red-800 mb-4">{error}</p>
        <button 
          onClick={() => window.location.reload()} 
          className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
        >
          ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
        </button>
      </div>
    </div>
  )

  return (
    <div className="bg-white overflow-hidden shadow rounded-lg">
      <div className="p-5">
        <div className="flex justify-between items-center">
          <div>
            <h3 className="text-lg font-medium text-gray-900">ÏßÅÏõê Ï†ïÎ≥¥ Í¥ÄÎ¶¨</h3>
            <p className="text-sm text-gray-500 mt-1">
              Ï†ÑÏ≤¥ {employees.length}Î™Ö | Ïû¨ÏßÅ {employees.filter(emp => !emp.termination_date).length}Î™Ö | Ìá¥ÏÇ¨ {employees.filter(emp => !!emp.termination_date).length}Î™Ö
            </p>
          </div>
          <div className="flex space-x-2">
            <button
              onClick={() => setStatusFilter('all')}
              className={`px-3 py-1 text-sm rounded-md ${statusFilter === 'all' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              Ï†ÑÏ≤¥
            </button>
            <button
              onClick={() => setStatusFilter('active')}
              className={`px-3 py-1 text-sm rounded-md ${statusFilter === 'active' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              Ïû¨ÏßÅÏ§ë
            </button>
            <button
              onClick={() => setStatusFilter('contract')}
              className={`px-3 py-1 text-sm rounded-md ${statusFilter === 'contract' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              Í≥ÑÏïΩÏßÅ
            </button>
            <button
              onClick={() => setStatusFilter('resigned')}
              className={`px-3 py-1 text-sm rounded-md ${statusFilter === 'resigned' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'}`}
            >
              Ìá¥ÏÇ¨
            </button>
          </div>
        </div>
        {error && <p className="text-sm text-red-500 mt-2">{error}</p>}
      </div>
      <div className="border-t border-gray-200 md:grid md:grid-cols-3">
        {/* Employee List */}
        <div className="md:col-span-1 border-r border-gray-200 h-96 overflow-y-auto">
          <ul>
            {filteredEmployees.map(emp => (
              <li key={emp.id}>
                <button
                  onClick={() => handleSelectEmployee(emp)}
                  className={`w-full text-left p-4 ${selectedEmployee?.id === emp.id ? 'bg-indigo-50' : 'hover:bg-gray-50'}`}
                >
                  <div className="flex justify-between items-start">
                    <div>
                      <p className="font-medium text-indigo-600">{emp.name} ({emp.position})</p>
                      <p className="text-sm text-gray-500">{emp.department}</p>
                    </div>
                    <div className="flex flex-col items-end">
                      <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        !emp.termination_date 
                          ? 'bg-green-100 text-green-800' 
                          : 'bg-red-100 text-red-800'
                      }`}>
                        {!emp.termination_date ? 'Ïû¨ÏßÅ' : 'Ìá¥ÏÇ¨'}
                      </span>
                      {emp.termination_date && (
                        <span className="text-xs text-gray-400 mt-1">
                          {new Date(emp.termination_date).toLocaleDateString('ko-KR')}
                        </span>
                      )}
                    </div>
                  </div>
                </button>
              </li>
            ))}
          </ul>
        </div>

        {/* Employee Management Panel */}
        <div className="md:col-span-2 p-6">
          {selectedEmployee ? (
            <div>
              {/* Tab Navigation */}
              <div className="border-b border-gray-200 mb-6">
                <nav className="-mb-px flex space-x-8">
                  <button
                    onClick={() => setActiveTab('info')}
                    className={`py-2 px-1 border-b-2 font-medium text-sm ${
                      activeTab === 'info'
                        ? 'border-indigo-500 text-indigo-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    Í∏∞Î≥∏ Ï†ïÎ≥¥
                  </button>
                  <button
                    onClick={() => setActiveTab('leave')}
                    className={`py-2 px-1 border-b-2 font-medium text-sm ${
                      activeTab === 'leave'
                        ? 'border-indigo-500 text-indigo-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    Ìú¥Í∞Ä Í¥ÄÎ¶¨
                  </button>
                  <button
                    onClick={() => setActiveTab('management')}
                    className={`py-2 px-1 border-b-2 font-medium text-sm ${
                      activeTab === 'management'
                        ? 'border-indigo-500 text-indigo-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    Ïù∏ÏÇ¨ Í¥ÄÎ¶¨
                  </button>
                </nav>
              </div>

              {/* Basic Info Tab */}
              {activeTab === 'info' && (
                <form onSubmit={handleSubmit} className="space-y-4">
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label htmlFor="name" className="block text-sm font-medium text-gray-700">Ïù¥Î¶Ñ</label>
                      <input type="text" name="name" id="name" value={formData.name || ''} onChange={handleInputChange} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                    </div>
                    <div>
                      <label htmlFor="email" className="block text-sm font-medium text-gray-700">Ïù¥Î©îÏùº</label>
                      <input type="email" name="email" id="email" value={formData.email || ''} onChange={handleInputChange} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                    </div>
                    <div>
                      <label htmlFor="department" className="block text-sm font-medium text-gray-700">Î∂ÄÏÑú</label>
                      <input type="text" name="department" id="department" value={formData.department || ''} onChange={handleInputChange} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                    </div>
                    <div>
                      <label htmlFor="position" className="block text-sm font-medium text-gray-700">ÏßÅÏ±Ö</label>
                      <input type="text" name="position" id="position" value={formData.position || ''} onChange={handleInputChange} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                    </div>
                    <div>
                      <label htmlFor="work_type" className="block text-sm font-medium text-gray-700">Í∑ºÎ¨¥ ÌòïÌÉú</label>
                      <select name="work_type" id="work_type" value={formData.work_type || ''} onChange={handleInputChange} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <option value="Ï†ïÍ∑úÏßÅ">Ï†ïÍ∑úÏßÅ</option>
                        <option value="Í≥ÑÏïΩÏßÅ">Í≥ÑÏïΩÏßÅ</option>
                        <option value="Ïù∏ÌÑ¥">Ïù∏ÌÑ¥</option>
                      </select>
                    </div>
                    <div>
                      <label htmlFor="hire_date" className="block text-sm font-medium text-gray-700">ÏûÖÏÇ¨Ïùº</label>
                      <input type="date" name="hire_date" id="hire_date" value={formData.hire_date || ''} onChange={handleInputChange} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
                    </div>
                  </div>
                  <div className="text-right">
                    <button
                      type="submit"
                      disabled={submitting}
                      className="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50"
                    >
                      {submitting ? 'Ï†ÄÏû• Ï§ë...' : 'Ï†ïÎ≥¥ Ï†ÄÏû•'}
                    </button>
                  </div>
                </form>
              )}

              {/* Leave Management Tab */}
              {activeTab === 'leave' && (
                <div className="space-y-6">
                  <h4 className="font-medium text-gray-900 mb-4">Ìú¥Í∞Ä ÌòÑÌô© Î∞è Ï°∞Ï†ï</h4>
                  <p className="text-sm text-gray-600 mb-4">Í∞Å Ìï≠Î™©ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏßÅÏ†ë ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {/* Ïó∞Ï∞® Ïπ¥Îìú */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <div className="flex justify-between items-center mb-3">
                        <h5 className="text-lg font-semibold text-blue-900">Ïó∞Ï∞®</h5>
                        <div className="text-2xl font-bold text-blue-600">
                          {selectedEmployee.annual_leave || 0}Ïùº ÏûîÏó¨
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        {/* ÏßÄÍ∏â ÏùºÏàò */}
                        <div className="flex justify-between items-center p-2 bg-white rounded border hover:bg-gray-50 cursor-pointer"
                             onClick={() => handleFieldEdit('annual_granted', (selectedEmployee as any)?.leave_data?.annual_days || 0)}>
                          <span className="text-sm font-medium text-gray-700">ÏßÄÍ∏â ÏùºÏàò</span>
                          {editingField === 'annual_granted' ? (
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={editValue}
                                onChange={(e) => setEditValue(e.target.value)}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    handleFieldSave('annual_granted', 'annual_leave', 'granted')
                                  } else if (e.key === 'Escape') {
                                    handleFieldCancel()
                                  }
                                }}
                                className="w-16 px-2 py-1 text-sm border rounded"
                                autoFocus
                              />
                              <button onClick={(e) => {e.stopPropagation(); handleFieldSave('annual_granted', 'annual_leave', 'granted')}} className="text-green-600 hover:text-green-800">‚úì</button>
                              <button onClick={(e) => {e.stopPropagation(); handleFieldCancel()}} className="text-red-600 hover:text-red-800">‚úï</button>
                            </div>
                          ) : (
                            <span className="text-lg font-semibold text-blue-600">{(selectedEmployee as any)?.leave_data?.annual_days || 0}Ïùº</span>
                          )}
                        </div>
                        
                        {/* ÏÇ¨Ïö© ÏùºÏàò */}
                        <div className="flex justify-between items-center p-2 bg-white rounded border hover:bg-gray-50 cursor-pointer"
                             onClick={() => handleFieldEdit('annual_used', (selectedEmployee as any)?.leave_data?.used_annual_days || 0)}>
                          <span className="text-sm font-medium text-gray-700">ÏÇ¨Ïö© ÏùºÏàò</span>
                          {editingField === 'annual_used' ? (
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={editValue}
                                onChange={(e) => setEditValue(e.target.value)}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    handleFieldSave('annual_used', 'annual_leave', 'used')
                                  } else if (e.key === 'Escape') {
                                    handleFieldCancel()
                                  }
                                }}
                                className="w-16 px-2 py-1 text-sm border rounded"
                                autoFocus
                              />
                              <button onClick={(e) => {e.stopPropagation(); handleFieldSave('annual_used', 'annual_leave', 'used')}} className="text-green-600 hover:text-green-800">‚úì</button>
                              <button onClick={(e) => {e.stopPropagation(); handleFieldCancel()}} className="text-red-600 hover:text-red-800">‚úï</button>
                            </div>
                          ) : (
                            <span className="text-lg font-semibold text-red-600">{(selectedEmployee as any)?.leave_data?.used_annual_days || 0}Ïùº</span>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Î≥ëÍ∞Ä Ïπ¥Îìú */}
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <div className="flex justify-between items-center mb-3">
                        <h5 className="text-lg font-semibold text-red-900">Î≥ëÍ∞Ä</h5>
                        <div className="text-2xl font-bold text-red-600">
                          {selectedEmployee.sick_leave || 0}Ïùº ÏûîÏó¨
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        {/* ÏßÄÍ∏â ÏùºÏàò */}
                        <div className="flex justify-between items-center p-2 bg-white rounded border hover:bg-gray-50 cursor-pointer"
                             onClick={() => handleFieldEdit('sick_granted', (selectedEmployee as any)?.leave_data?.sick_days || 0)}>
                          <span className="text-sm font-medium text-gray-700">ÏßÄÍ∏â ÏùºÏàò</span>
                          {editingField === 'sick_granted' ? (
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={editValue}
                                onChange={(e) => setEditValue(e.target.value)}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    handleFieldSave('sick_granted', 'sick_leave', 'granted')
                                  } else if (e.key === 'Escape') {
                                    handleFieldCancel()
                                  }
                                }}
                                className="w-16 px-2 py-1 text-sm border rounded"
                                autoFocus
                              />
                              <button onClick={(e) => {e.stopPropagation(); handleFieldSave('sick_granted', 'sick_leave', 'granted')}} className="text-green-600 hover:text-green-800">‚úì</button>
                              <button onClick={(e) => {e.stopPropagation(); handleFieldCancel()}} className="text-red-600 hover:text-red-800">‚úï</button>
                            </div>
                          ) : (
                            <span className="text-lg font-semibold text-blue-600">{(selectedEmployee as any)?.leave_data?.sick_days || 0}Ïùº</span>
                          )}
                        </div>
                        
                        {/* ÏÇ¨Ïö© ÏùºÏàò */}
                        <div className="flex justify-between items-center p-2 bg-white rounded border hover:bg-gray-50 cursor-pointer"
                             onClick={() => handleFieldEdit('sick_used', (selectedEmployee as any)?.leave_data?.used_sick_days || 0)}>
                          <span className="text-sm font-medium text-gray-700">ÏÇ¨Ïö© ÏùºÏàò</span>
                          {editingField === 'sick_used' ? (
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={editValue}
                                onChange={(e) => setEditValue(e.target.value)}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    handleFieldSave('sick_used', 'sick_leave', 'used')
                                  } else if (e.key === 'Escape') {
                                    handleFieldCancel()
                                  }
                                }}
                                className="w-16 px-2 py-1 text-sm border rounded"
                                autoFocus
                              />
                              <button onClick={(e) => {e.stopPropagation(); handleFieldSave('sick_used', 'sick_leave', 'used')}} className="text-green-600 hover:text-green-800">‚úì</button>
                              <button onClick={(e) => {e.stopPropagation(); handleFieldCancel()}} className="text-red-600 hover:text-red-800">‚úï</button>
                            </div>
                          ) : (
                            <span className="text-lg font-semibold text-red-600">{(selectedEmployee as any)?.leave_data?.used_sick_days || 0}Ïùº</span>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* ÎåÄÏ≤¥Ìú¥Í∞Ä Ïπ¥Îìú */}
                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                      <div className="flex justify-between items-center mb-3">
                        <h5 className="text-lg font-semibold text-purple-900">ÎåÄÏ≤¥Ìú¥Í∞Ä</h5>
                        <div className="text-2xl font-bold text-purple-600">
                          {selectedEmployee.substitute_leave_hours || 0}ÏãúÍ∞Ñ
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        <div className="flex justify-between items-center p-2 bg-white rounded border hover:bg-gray-50 cursor-pointer"
                             onClick={() => handleFieldEdit('substitute_hours', selectedEmployee.substitute_leave_hours || 0)}>
                          <span className="text-sm font-medium text-gray-700">Î≥¥Ïú† ÏãúÍ∞Ñ</span>
                          {editingField === 'substitute_hours' ? (
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={editValue}
                                onChange={(e) => setEditValue(e.target.value)}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    handleFieldSave('substitute_hours', 'substitute_leave_hours', 'granted')
                                  } else if (e.key === 'Escape') {
                                    handleFieldCancel()
                                  }
                                }}
                                className="w-16 px-2 py-1 text-sm border rounded"
                                autoFocus
                              />
                              <button onClick={(e) => {e.stopPropagation(); handleFieldSave('substitute_hours', 'substitute_leave_hours', 'granted')}} className="text-green-600 hover:text-green-800">‚úì</button>
                              <button onClick={(e) => {e.stopPropagation(); handleFieldCancel()}} className="text-red-600 hover:text-red-800">‚úï</button>
                            </div>
                          ) : (
                            <span className="text-lg font-semibold text-purple-600">{selectedEmployee.substitute_leave_hours || 0}ÏãúÍ∞Ñ</span>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Î≥¥ÏÉÅÌú¥Í∞Ä Ïπ¥Îìú */}
                    <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                      <div className="flex justify-between items-center mb-3">
                        <h5 className="text-lg font-semibold text-orange-900">Î≥¥ÏÉÅÌú¥Í∞Ä</h5>
                        <div className="text-2xl font-bold text-orange-600">
                          {selectedEmployee.compensatory_leave_hours || 0}ÏãúÍ∞Ñ
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        <div className="flex justify-between items-center p-2 bg-white rounded border hover:bg-gray-50 cursor-pointer"
                             onClick={() => handleFieldEdit('compensatory_hours', selectedEmployee.compensatory_leave_hours || 0)}>
                          <span className="text-sm font-medium text-gray-700">Î≥¥Ïú† ÏãúÍ∞Ñ</span>
                          {editingField === 'compensatory_hours' ? (
                            <div className="flex items-center gap-2">
                              <input
                                type="number"
                                value={editValue}
                                onChange={(e) => setEditValue(e.target.value)}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    handleFieldSave('compensatory_hours', 'compensatory_leave_hours', 'granted')
                                  } else if (e.key === 'Escape') {
                                    handleFieldCancel()
                                  }
                                }}
                                className="w-16 px-2 py-1 text-sm border rounded"
                                autoFocus
                              />
                              <button onClick={(e) => {e.stopPropagation(); handleFieldSave('compensatory_hours', 'compensatory_leave_hours', 'granted')}} className="text-green-600 hover:text-green-800">‚úì</button>
                              <button onClick={(e) => {e.stopPropagation(); handleFieldCancel()}} className="text-red-600 hover:text-red-800">‚úï</button>
                            </div>
                          ) : (
                            <span className="text-lg font-semibold text-orange-600">{selectedEmployee.compensatory_leave_hours || 0}ÏãúÍ∞Ñ</span>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h5 className="text-sm font-medium text-yellow-800 mb-2">üí° ÏÇ¨Ïö© ÏïàÎÇ¥</h5>
                    <ul className="text-sm text-yellow-700 space-y-1">
                      <li>‚Ä¢ Í∞Å Ìï≠Î™©ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÏßÅÏ†ë ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§</li>
                      <li>‚Ä¢ Enter ÌÇ§Î°ú Ï†ÄÏû•, Esc ÌÇ§Î°ú Ï∑®ÏÜåÌï† Ïàò ÏûàÏäµÎãàÎã§</li>
                      <li>‚Ä¢ Ïó∞Ï∞®/Î≥ëÍ∞ÄÎäî ÏßÄÍ∏â ÏùºÏàòÏôÄ ÏÇ¨Ïö© ÏùºÏàòÎ•º Î≥ÑÎèÑÎ°ú Í¥ÄÎ¶¨Ìï©ÎãàÎã§</li>
                      <li>‚Ä¢ ÎåÄÏ≤¥Ìú¥Í∞Ä/Î≥¥ÏÉÅÌú¥Í∞ÄÎäî Î≥¥Ïú† ÏãúÍ∞ÑÏùÑ ÏßÅÏ†ë ÏÑ§Ï†ïÌï©ÎãàÎã§</li>
                    </ul>
                  </div>
                </div>
              )}

              {/* HR Management Tab */}
              {activeTab === 'management' && (
                <div className="space-y-6">
                  {/* Resignation Processing */}
                  <div className="bg-yellow-50 p-4 rounded-lg">
                    <h4 className="font-medium text-gray-900 mb-4">Ìá¥ÏÇ¨ Ï≤òÎ¶¨</h4>
                    <div className="space-y-4">
                      <div>
                        <label htmlFor="resignation_date" className="block text-sm font-medium text-gray-700">Ìá¥ÏÇ¨Ïùº</label>
                        <input
                          type="date"
                          name="resignation_date"
                          id="resignation_date"
                          value={formData.resignation_date || ''}
                          onChange={handleInputChange}
                          className="mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                        />
                      </div>
                      <button
                        type="button"
                        onClick={handleResignation}
                        disabled={submitting || !formData.resignation_date}
                        className="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50"
                      >
                        {submitting ? 'Ï≤òÎ¶¨ Ï§ë...' : 'Ìá¥ÏÇ¨ Ï≤òÎ¶¨'}
                      </button>
                    </div>
                  </div>

                  {/* Employee Deletion */}
                  <div className="bg-red-50 p-4 rounded-lg">
                    <h4 className="font-medium text-gray-900 mb-4">ÏßÅÏõê ÏÇ≠Ï†ú</h4>
                    <p className="text-sm text-gray-600 mb-4">
                      Ï£ºÏùò: ÏßÅÏõêÏùÑ ÏÇ≠Ï†úÌïòÎ©¥ Î™®Îì† Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎê©ÎãàÎã§.
                    </p>
                    {!showDeleteConfirm ? (
                      <button
                        type="button"
                        onClick={() => setShowDeleteConfirm(true)}
                        className="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"
                      >
                        ÏßÅÏõê ÏÇ≠Ï†ú
                      </button>
                    ) : (
                      <div className="space-y-3">
                        <p className="text-sm font-medium text-red-800">
                          Ï†ïÎßêÎ°ú {selectedEmployee.name} ÏßÅÏõêÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                        </p>
                        <div className="flex gap-2">
                          <button
                            type="button"
                            onClick={handleDeleteEmployee}
                            disabled={submitting}
                            className="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 disabled:opacity-50"
                          >
                            {submitting ? 'ÏÇ≠Ï†ú Ï§ë...' : 'ÏÇ≠Ï†ú ÌôïÏù∏'}
                          </button>
                          <button
                            type="button"
                            onClick={() => setShowDeleteConfirm(false)}
                            className="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                          >
                            Ï∑®ÏÜå
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          ) : (
            <div className="text-center py-12">
              <p className="text-gray-500">ÏôºÏ™Ω Î™©Î°ùÏóêÏÑú ÏßÅÏõêÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
