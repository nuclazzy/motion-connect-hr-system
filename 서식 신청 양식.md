code.gs

/**
 * 파일명: Code.gs
 */

// ===============================================================
// 사용자 설정 영역
// ===============================================================
const TEMPLATE_IDS = {
  '휴가 신청서': '1clqbPDkbz2meuzXyjSQa_zcklXr7etrqySPa8f9k-Tw',
  '재직증명서': '1_A2eLH3W401C8VuMVUM8rI845xhfpgSd2B7Qg4xNOMw',
  '휴직계': '1g2kZpM99mHO8GcbY4oNykE0Co5XvROG1sv9-CM2acN0',
  '출산휴가 및 육아휴직 신청서': '1fsdGGQAKl4AdHAIBB3A3OT-DOoKxBvhFGzwZj0EfV_I',
  '경위서': '1-BvtP2meiuK-cuBSYKAXgSmaGRSWLZkcGt5Rj1-szGA'
};
const DESTINATION_FOLDER_ID = '1XSspvlvNff6HUPvEtyluNMH9htOk6_8d';
const EMPLOYEE_DATA_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1hS0UE8BhzpDi2yLv2CCOU1krncQMOWEAnxTQk0hZrRE/edit';
const LOG_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1g0TAnQdjf3wjgtPkTBltAKKKFTO2ultNDjCLWmcmpKo/edit';


// ===============================================================
// 메인 서버 코드
// ===============================================================

/**
 * URL 파라미터를 한글 서식명으로 변환하기 위한 맵
 */
const FORM_TYPE_MAP = {
  'report': '경위서',
  'vacation': '휴가 신청서',
  'certificate': '재직증명서',
  'leave': '휴직계',
  'maternity': '출산휴가 및 육아휴직 신청서'
};


/**
 * 로그인한 사용자의 모든 정보를 조회하는 표준 함수
 */
function getUserInfo() {
  try {
    const userEmail = Session.getActiveUser().getEmail();

    if (!userEmail) {
      return { status: 'ANONYMOUS', data: null };
    }

    const sheet = SpreadsheetApp.openByUrl(EMPLOYEE_DATA_SHEET_URL).getSheetByName('임금테이블');
    if (!sheet) {
      throw new Error("'임금테이블' 시트를 찾을 수 없습니다.");
    }

    const data = sheet.getRange("A3:S").getValues();

    for (const row of data) {
      const name = row[1]; // B열: 성명
      const emailInSheet = row[7]; // H열: 이메일
      const resignationDate = row[13]; // N열: 퇴사일

      if (name && emailInSheet && emailInSheet.toString().trim().toLowerCase() === userEmail.toLowerCase() && !resignationDate) {
        return {
          status: 'SUCCESS',
          data: {
            사번: row[0],
            성명: name,
            부서: row[3],
            직위: row[4],
            생년월일: parseSheetDate(row[5]),
            연락처: row[6],
            주소: row[8],
            입사일: parseSheetDate(row[12]),
            사용연차: row[16] || 0,
            남은연차: row[17] || 0,
            남은병가: row[18] || 0
          }
        };
      }
    }
    return { status: 'NOT_FOUND', data: null };
  } catch (e) {
    console.error("getUserInfo Error: " + e.toString());
    return { status: 'ERROR', data: null, message: e.toString() };
  }
}

/**
 * URL 파라미터(e)에 따라 어떤 서식을 보여줄지 결정하여 HTML 템플릿에 전달
 */
function doGet(e) {
  const formParam = e.parameter.form; 
  const docType = FORM_TYPE_MAP[formParam] || ''; 

  const template = HtmlService.createTemplateFromFile('index');
  template.docType = docType;
  template.formMap = FORM_TYPE_MAP;
  template.baseUrl = ScriptApp.getService().getUrl();

  const pageTitle = docType ? `${docType} 자동 생성` : '서식 자동 생성 시스템';

  return template.evaluate()
    .setTitle(pageTitle)
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}


function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function parseSheetDate(dateValue) {
  if (!dateValue) return null;
  if (dateValue instanceof Date && !isNaN(dateValue)) {
    return Utilities.formatDate(dateValue, "GMT+9", "yyyy-MM-dd");
  }
  if (typeof dateValue === 'string') {
    const trimmedValue = dateValue.trim();
    if (/^\d{4}\.\d{2}\.\d{2}$/.test(trimmedValue)) return trimmedValue.replace(/\./g, '-');
    if (/^\d{2}\.\d{2}\.\d{2}$/.test(trimmedValue)) {
      const parts = trimmedValue.split('.');
      return `20${parts[0]}-${parts[1]}-${parts[2]}`;
    }
  }
  return null;
}

function formatDateToKorean(dateString) {
  if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
  const parts = dateString.split('-');
  return `${parts[0]}년 ${parts[1]}월 ${parts[2]}일`;
}

function getEmployeeVacationInfo(employeeName) {
  try {
    const sheet = SpreadsheetApp.openByUrl(EMPLOYEE_DATA_SHEET_URL).getSheetByName('임금테이블');
    if (!sheet) throw new Error("'임금테이블' 시트를 찾을 수 없습니다.");
    const data = sheet.getRange("B3:S").getValues();
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === employeeName) {
        return {
          success: true,
          사용연차: data[i][15] || 0,
          남은연차: data[i][16] || 0,
          남은병가: data[i][17] || 0,
          rowIndex: i + 3
        };
      }
    }
    return { success: false, message: "직원을 찾을 수 없습니다." };
  } catch (e) {
    return { success: false, message: "휴가 정보 조회 실패: " + e.message };
  }
}

function updateVacationData(employeeName, vacationType, usedDays) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const sheet = SpreadsheetApp.openByUrl(EMPLOYEE_DATA_SHEET_URL).getSheetByName('임금테이블');
    if (!sheet) throw new Error("'임금테이블' 시트를 찾을 수 없습니다.");
    const vacationInfo = getEmployeeVacationInfo(employeeName);
    if (!vacationInfo.success) throw new Error(vacationInfo.message);

    const rowIndex = vacationInfo.rowIndex;
    const usedDaysFloat = parseFloat(usedDays) || 0;

    if (['연차', '오전 반차', '오후 반차'].includes(vacationType)) {
      const newUsed = (parseFloat(vacationInfo.사용연차) || 0) + usedDaysFloat;
      const newRemaining = (parseFloat(vacationInfo.남은연차) || 0) - usedDaysFloat;
      if (newRemaining < 0) throw new Error("최신 잔여일수 확인 결과, 연차가 부족합니다.");
      sheet.getRange(`Q${rowIndex}`).setValue(newUsed);
      sheet.getRange(`R${rowIndex}`).setValue(newRemaining);
    } else if (vacationType === '병가') {
      const newRemaining = (parseFloat(vacationInfo.남은병가) || 0) - usedDaysFloat;
      if (newRemaining < 0) throw new Error("최신 잔여일수 확인 결과, 병가가 부족합니다.");
      sheet.getRange(`S${rowIndex}`).setValue(newRemaining);
    }
    return { success: true };
  } catch (e) {
    console.error("휴가 데이터 업데이트 실패: " + e.message);
    return { success: false, message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function updateAddress(employeeName, newAddress) {
  try {
    const sheet = SpreadsheetApp.openByUrl(EMPLOYEE_DATA_SHEET_URL).getSheetByName('임금테이블');
    if (!sheet) throw new Error("'임금테이블' 시트를 찾을 수 없습니다.");
    const data = sheet.getRange("B3:B").getValues();
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === employeeName) {
        sheet.getRange(`I${i + 3}`).setValue(newAddress);
        return { success: true };
      }
    }
    return { success: false, message: '주소 업데이트 대상을 찾지 못함' };
  } catch (e) {
    console.error("주소 업데이트 실패: " + e.message);
    return { success: false, message: e.message };
  }
}

function createDocument(formData) {
  try {
    if (formData.isAddressChanged === 'true') updateAddress(formData.성명, formData.주소);
    
    const docType = formData.docType;
    const templateId = TEMPLATE_IDS[docType];
    if (!templateId) throw new Error(`템플릿 ID를 찾을 수 없음: ${docType}`);

    if (docType === '휴가 신청서') {
      let vacationDays = parseFloat(formData.휴가일수) || 0;
      if (['오전 반차', '오후 반차'].includes(formData.휴가형태)) {
        vacationDays = 0.5;
        formData.휴가일수 = '0.5';
      }
      if (['연차', '오전 반차', '오후 반차', '병가'].includes(formData.휴가형태) && vacationDays > 0) {
        const vacationInfo = getEmployeeVacationInfo(formData.성명);
        if (!vacationInfo.success) throw new Error(`휴가 정보 조회 실패: ${vacationInfo.message}`);
        
        if (['연차', '오전 반차', '오후 반차'].includes(formData.휴가형태)) {
          if (vacationDays > vacationInfo.남은연차) throw new Error(`연차 잔여일수가 부족합니다. (신청: ${vacationDays}일, 잔여: ${vacationInfo.남은연차}일)`);
        } else if (formData.휴가형태 === '병가') {
          if (vacationDays > vacationInfo.남은병가) throw new Error(`병가 잔여일수가 부족합니다. (신청: ${vacationDays}일, 잔여: ${vacationInfo.남은병가}일)`);
        }
      }
    }

    const folder = DriveApp.getFolderById(DESTINATION_FOLDER_ID);
    const templateFile = DriveApp.getFileById(templateId);
    if (docType === '재직증명서') formData['넘버링'] = Utilities.formatDate(new Date(), "GMT+9", "yyMMdd-HH");
    const applicationDate = formData['신청일'] || formData['신청일자'] || Utilities.formatDate(new Date(), "GMT+9", "yyyy-MM-dd");
    const newFileName = `[${applicationDate}] ${formData['성명']}_${docType}`;
    const newFile = templateFile.makeCopy(newFileName, folder);
    const doc = DocumentApp.openById(newFile.getId());
    const body = doc.getBody();

    const dateFieldsToConvert = ['시작일', '종료일', '신청일', '출산예정일', '출산휴가시작일', '출산휴가종료일', '육아휴직시작일', '육아휴직종료일', '육아기단축시작일', '육아기단축종료일', '전환형시작일', '전환형종료일', '입사일'];
    for (const key in formData) {
      let value = formData[key] || '';
      if (dateFieldsToConvert.includes(key)) value = formatDateToKorean(value);
      if (key === '휴직일수' && value && docType === '휴직계') value += '일';
      if (docType === '휴가 신청서') {
        if (key === '휴가기간') {
          if (['오전 반차', '오후 반차'].includes(formData['휴가형태'])) value = `${formatDateToKorean(formData['시작일'])} (${formData['휴가형태'] === '오전 반차' ? '오전' : '오후'})`;
          else if (formData['시작일'] && formData['종료일']) value = `${formatDateToKorean(formData['시작일'])} ~ ${formatDateToKorean(formData['종료일'])}`;
        } else if (key === '휴가일수') {
          if (['오전 반차', '오후 반차'].includes(formData['휴가형태'])) value = '0.5일';
          else if (value) value += '일';
        }
      }
      body.replaceText(`{{${key}}}`, value);
    }
    doc.saveAndClose();

    if (docType === '휴가 신청서') {
      const vacationType = formData.휴가형태;
      let vacationDays = parseFloat(formData.휴가일수) || 0;
      if (['오전 반차', '오후 반차'].includes(vacationType)) vacationDays = 0.5;
      if (['연차', '오전 반차', '오후 반차', '병가'].includes(vacationType) && vacationDays > 0) {
        updateVacationData(formData.성명, vacationType, vacationDays);
      }
    }

    const pdfBlob = newFile.getAs('application/pdf');
    const pdfBase64 = Utilities.base64Encode(pdfBlob.getBytes());
    
    logRequestToSheet({
      applicant: formData['성명'],
      documentType: docType,
      department: formData['부서'],
      fileName: newFile.getName() + '.pdf'
    });

    return { success: true, pdfBase64: pdfBase64, fileName: newFile.getName() + '.pdf' };
  } catch (e) {
    console.error("createDocument Error: " + e.message, e.stack);
    return { success: false, message: e.message };
  }
}

function logRequestToSheet(logData) {
  try {
    const logSpreadsheet = SpreadsheetApp.openByUrl(LOG_SHEET_URL);
    const now = new Date();
    const sheetName = Utilities.formatDate(now, "GMT+9", "yyyy년 MM월");
    let sheet = logSpreadsheet.getSheetByName(sheetName);
    if (!sheet) {
      sheet = logSpreadsheet.insertSheet(sheetName, 0);
      const headerRow = ['신청일시', '신청자', '부서', '신청서류', '처리상태', '비고'];
      sheet.getRange(1, 1, 1, headerRow.length).setValues([headerRow])
           .setFontWeight("bold").setBackground("#4a90e2").setFontColor("#ffffff").setHorizontalAlignment("center");
      sheet.setColumnWidths(1, 6, 150).setColumnWidth(4, 250);
    }
    const newRow = [
      Utilities.formatDate(now, "GMT+9", "yyyy-MM-dd HH:mm:ss"),
      logData.applicant,
      logData.department,
      logData.documentType,
      '생성완료',
      `PDF 생성: ${logData.fileName}`
    ];
    sheet.insertRowAfter(1);
    sheet.getRange(2, 1, 1, newRow.length).setValues([newRow]).setBackground("#ffffff").setFontColor("#000000");
  } catch (e) {
    console.error("로그 기록 실패: " + e.toString());
  }
}

index.Html

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #4a90e2; --primary-hover-color: #357abd; --text-color: #333;
        --label-color: #555; --border-color: #ddd; --bg-color: #f9fbfd;
        --section-bg-color: #ffffff; --info-bg-color: #e8f4fd; --info-border-color: var(--primary-color);
        --success-color: #2e7d32; --warning-color: #d32f2f;
      }
      body { background-color: var(--bg-color); font-family: 'Noto Sans KR', sans-serif; color: var(--text-color); padding: 20px; -webkit-font-smoothing: antialiased; }
      .wrapper { max-width: 800px; margin: 20px auto; }
      .section { background-color: var(--section-bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
      .section-title { font-size: 1.4em; font-weight: 700; color: var(--primary-color); margin-top: 0; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
      label { font-weight: 500; color: var(--label-color); margin-bottom: 8px; font-size: 0.95em; display: block; }
      input[type="text"], input[type="date"], input[type="time"], select, textarea { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; font-family: 'Noto Sans KR', sans-serif; transition: all 0.3s ease; }
      input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); }
      .auto-filled { background-color: #f5f5f5; color: #777; }
      .form-row { display: flex; flex-direction: column; margin-bottom: 18px; }
      .action { background-color: var(--primary-color); color: white; font-weight: 500; font-size: 1.1em; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
      .action:hover { background-color: var(--primary-hover-color); }
      .action:disabled { background-color: #ccc; cursor: not-allowed; }
      .info-message, .warning-message { padding: 12px; border-radius: 8px; margin-top: 15px; font-weight: 500; }
      .info-message { color: var(--success-color); background-color: #e8f5e9; border: 1px solid #a5d6a7; }
      .warning-message { color: var(--warning-color); background-color: #ffebee; border: 1px solid #ef9a9a; }
      #vacation-info .info-message { background-color: var(--info-bg-color); border: 1px solid var(--info-border-color); color: var(--primary-color); border-left: 5px solid var(--primary-color); }
      #status { margin-top: 15px; font-weight: 500; }
      #loader { display: none; text-align: center; margin: 20px 0; }
      .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px auto; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .form-container { display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
      .calculated-field { background-color: #e8f0fe; border: 1px solid #ccc; padding: 6px; font-weight: bold; border-radius: 6px; display: inline-block; margin-left: 10px; }
      .sub-section-title { font-weight: bold; font-size: 1.1em; margin: 20px 0 10px; color: #1e8e3e; border-left: 4px solid #1e8e3e; padding-left: 8px; }
      .info-box { background-color: #f1f3f4; border-left: 5px solid #ccc; margin: 15px 0; padding: 15px; border-radius: 8px; }
      textarea { min-height: 80px; resize: vertical; }
      #form-link-list { list-style-type: none; padding-left: 0; }
      #form-link-list li { margin-bottom: 8px; }
      #form-link-list li a { display: block; padding: 10px 15px; background-color: #f8f9fa; border-radius: 6px; text-decoration: none; color: var(--primary-color); font-weight: 500; transition: all 0.2s ease-in-out; }
      #form-link-list li a:hover { background-color: #e9ecef; transform: translateX(4px); }
    </style>
  </head>
  <body>
    <script>
      const FORM_MAP = <?!= JSON.stringify(formMap) ?>;
      const BASE_URL = '<?= baseUrl ?>';
    </script>

    <input type="hidden" id="initial-doc-type" value="<?= docType ?>">

    <div class="wrapper">
      <div id="login-section" style="display: none;" class="section">
        <h2 class="section-title">🔒 로그인이 필요합니다</h2>
        <p>Google 계정으로 로그인해주세요.</p>
      </div>

      <div id="initial-guide-section" class="section" style="display: none;"></div>
      
      <div id="user-info-section" class="section" style="display: none;">
        <h2 class="section-title">1. 신청자 정보 확인</h2>
        <div class="form-row"><label for="employee-name">성명</label><input type="text" id="employee-name" class="employee-data auto-filled" name="성명" readonly></div>
        <div id="vacation-info" style="margin-top: 10px;"></div>
      </div>
      
      <div id="form-selection-section" class="section" style="display:none;">
        <h2 class="section-title">2. 세부 정보 입력</h2>
        <div class="form-row"><label>신청 서류</label><h3 id="form-title" style="margin:0;padding:12px;background-color:#f0f4f8;border-radius:8px;font-size:1.1em"></h3></div>
        <div class="form-row"><label for="user-dept">부서</label><input type="text" id="user-dept" class="employee-data auto-filled" name="부서" readonly></div>
        <div class="form-row"><label for="user-pos">직위</label><input type="text" id="user-pos" class="employee-data auto-filled" name="직위" readonly></div>
        <div class="form-row"><label for="user-phone">연락처</label><input type="text" id="user-phone" class="employee-data" name="연락처"></div>
        <div class="form-row"><label for="user-address">주소 (수정 가능)</label><input type="text" id="user-address" class="employee-data" name="주소" onchange="markAddressChanged()"></div>
        <input type="hidden" id="isAddressChanged" name="isAddressChanged" value="false">
        <input type="hidden" class="employee-data" name="사번">
        <input type="hidden" class="employee-data" name="생년월일">
        <input type="hidden" class="employee-data" name="입사일">
        
        <div id="경위서" class="form-container" style="display:none;"><?!= include('Form.Report'); ?></div>
        <div id="휴가 신청서" class="form-container" style="display:none;"><?!= include('Form.Vacation'); ?></div>
        <div id="재직증명서" class="form-container" style="display:none;"><?!= include('Form.Certificate'); ?></div>
        <div id="휴직계" class="form-container" style="display:none;"><?!= include('Form.Leave'); ?></div>
        <div id="출산휴가 및 육아휴직 신청서" class="form-container" style="display:none;"><?!= include('Form.Maternity'); ?></div>
      </div>
      
      <div id="submission-block" class="section" style="display:none;">
        <button id="submit-button" class="action" onclick="submitForm()">문서 생성하기</button>
        <div id="loader"><div class="spinner"></div><p>처리 중입니다...</p></div>
        <div id="status"></div>
      </div>
    </div>
    
    <?!= include('JavaScript'); ?>
  </body>
</html>

JavaScript.html

<script>
/**
 * 파일명: JavaScript.html
 */
let currentUserData = null;

document.addEventListener("DOMContentLoaded", function() {
  initializeSystem();
  const today = new Date().toISOString().slice(0, 10);
  document.querySelectorAll('.default-today').forEach(input => {
    if (!input.value) input.value = today;
  });
});

function initializeSystem() {
  google.script.run
    .withSuccessHandler(handleUserInfoResponse)
    .withFailureHandler(handleError)
    .getUserInfo();
}

function handleUserInfoResponse(response) {
  const guideSection = document.getElementById('initial-guide-section');
  const userInfoSection = document.getElementById('user-info-section');
  const formSection = document.getElementById('form-selection-section');
  const submissionBlock = document.getElementById('submission-block');
  const loginSection = document.getElementById('login-section');
  
  [guideSection, userInfoSection, formSection, submissionBlock, loginSection].forEach(el => el.style.display = 'none');
  
  switch (response.status) {
    case 'SUCCESS':
      currentUserData = response.data;
      populateFormWithUserData(currentUserData);
      const docType = document.getElementById('initial-doc-type').value;
      if (docType) {
        document.getElementById('form-title').textContent = docType;
        userInfoSection.style.display = 'block';
        formSection.style.display = 'block';
        submissionBlock.style.display = 'block';
        showForm(docType); 
      } else {
        guideSection.style.display = 'block';
        let listHtml = '';
        for (const key in FORM_MAP) {
          listHtml += `<li><a href="${BASE_URL}?form=${key}">${FORM_MAP[key]}</a></li>`;
        }
        guideSection.innerHTML = `<h2 class="section-title">📋 사용 가능한 서식 목록</h2><p>작성을 원하는 서식을 선택하세요.</p><ul id="form-link-list">${listHtml}</ul>`;
      }
      break;
    case 'ANONYMOUS':
      loginSection.style.display = 'block';
      break;
    case 'NOT_FOUND':
      guideSection.style.display = 'block';
      guideSection.innerHTML = `<h2 class="section-title">❌ 접근 권한 없음</h2><p class="warning-message">'임금테이블' 시트에 등록된 구글 계정으로 접속해주세요.</p>`;
      break;
    default:
      handleError({ message: response.message || '알 수 없는 서버 오류' });
      break;
  }
}

function handleError(error) {
  document.getElementById('initial-guide-section').innerHTML = `<div class="warning-message">❌ 시스템 오류: ${error.message || '알 수 없는 오류'}</div>`;
  console.error("시스템 오류:", error);
}

function populateFormWithUserData(employee) {
  if (!employee) return;
  document.querySelectorAll('.employee-data').forEach(input => {
    const fieldName = input.getAttribute('name');
    if (employee[fieldName] !== undefined) input.value = employee[fieldName] || '';
  });
  updateVacationInfo(employee);
  // 재직증명서의 재직기간을 즉시 계산
  if(document.getElementById('재직증명서')) setTimeout(calculateEmploymentPeriod, 100);
}

function updateVacationInfo(employee) {
  const vacationInfoDiv = document.getElementById('vacation-info');
  if (vacationInfoDiv) {
    vacationInfoDiv.innerHTML = `<div class="info-message"><strong>휴가 현황:</strong> 남은 연차 ${employee.남은연차 || 0}일 | 사용 연차 ${employee.사용연차 || 0}일 | 남은 병가 ${employee.남은병가 || 0}일</div>`;
  }
}

function markAddressChanged() {
  document.getElementById('isAddressChanged').value = 'true';
}

function showForm(selectedValue) {
  const vacationInfoDiv = document.getElementById('vacation-info');
  if (vacationInfoDiv) {
    const leaveRelatedForms = ['휴가 신청서', '출산휴가 및 육아휴직 신청서', '휴직계'];
    vacationInfoDiv.style.display = leaveRelatedForms.includes(selectedValue) ? 'block' : 'none';
  }

  document.querySelectorAll('.form-container').forEach(form => {
    form.style.display = 'none';
  });
  
  const formContainer = document.getElementById(selectedValue);
  if (formContainer) {
    formContainer.style.display = 'block';
  }
}

function toggleOtherField(selectElement, otherFieldId) {
  const otherField = document.getElementById(otherFieldId);
  if (otherField) otherField.style.display = (selectElement.value === '기타') ? 'block' : 'none';
}

function toggleReasonField(selectElement, reasonFieldId) {
  const reasonField = document.getElementById(reasonFieldId);
  if (reasonField) reasonField.style.display = (['연차', '오전 반차', '오후 반차'].includes(selectElement.value)) ? 'none' : 'block';
}

function showSickLeaveWarning(selectElement) {
  const sickLeaveWarningDiv = document.getElementById('sick-leave-warning');
  if (!sickLeaveWarningDiv) return;
  if (selectElement.value === '병가') {
    sickLeaveWarningDiv.innerHTML = `<div class="info-message" style="background-color: #fffbe6; border-color: #ffe58f; color: #d46b08;"><strong>⚠️ 병가 사용 안내</strong><br>병가 사용은 연차를 모두 소진한 후, 피치 못할 사정이 있을 경우에만 신청해 주시기 바랍니다.</div>`;
    sickLeaveWarningDiv.style.display = 'block';
  } else {
    sickLeaveWarningDiv.style.display = 'none';
  }
}

function calculateDays(formId, startDateName, endDateName, resultSpanId, hiddenInputName) {
  const form = document.getElementById(formId);
  const startDate = form.querySelector(`input[name="${startDateName}"]`).value;
  const endDate = form.querySelector(`input[name="${endDateName}"]`).value;
  const resultSpan = document.getElementById(resultSpanId);
  const hiddenInput = form.querySelector(`input[name="${hiddenInputName}"]`);
  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    if (end < start) { resultSpan.textContent = "종료일 오류"; hiddenInput.value = ""; return; }
    const diffDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
    hiddenInput.value = diffDays;
    resultSpan.textContent = `${diffDays} 일`;
  }
}

function calculateHours(formId, startTimeName, endTimeName, resultSpanId, hiddenInputName) {
  const form = document.getElementById(formId);
  const startTime = form.querySelector(`input[name="${startTimeName}"]`).value;
  const endTime = form.querySelector(`input[name="${endTimeName}"]`).value;
  const resultSpan = document.getElementById(resultSpanId);
  const hiddenInput = form.querySelector(`input[name="${hiddenInputName}"]`);
  if (startTime && endTime) {
    const start = new Date(`1970-01-01T${startTime}:00`);
    const end = new Date(`1970-01-01T${endTime}:00`);
    if (end < start) { resultSpan.textContent = "종료시간 오류"; hiddenInput.value = ""; return; }
    const diffMinutes = (end - start) / 60000;
    const hours = Math.floor(diffMinutes / 60);
    const minutes = diffMinutes % 60;
    const text = `${hours}시간 ${minutes}분`;
    resultSpan.textContent = text;
    hiddenInput.value = text;
  }
}

function calculateEmploymentPeriod() {
  const form = document.getElementById('재직증명서');
  if(!form || !form.innerHTML) return;
  const hireDate = form.querySelector('input[name="입사일"]').value;
  const requestDate = form.querySelector('input[name="신청일"]').value;
  const resultSpan = document.getElementById('form5_재직일');
  const hiddenInput = form.querySelector('input[name="재직일"]');
  if (hireDate && requestDate) {
    const start = new Date(hireDate);
    const end = new Date(requestDate);
    if (end < start) { resultSpan.textContent = "신청일 오류"; hiddenInput.value = ""; return; }
    let years = end.getFullYear() - start.getFullYear();
    let months = end.getMonth() - start.getMonth();
    if (end.getDate() < start.getDate()) months--;
    if (months < 0) { years--; months += 12; }
    const text = `${years}년 ${months}개월`;
    resultSpan.textContent = text;
    hiddenInput.value = text;
  }
}

function submitForm() {
  const docType = document.getElementById('initial-doc-type').value;
  if (!docType) { alert("잘못된 접근입니다."); return; }
  
  if (docType === '휴가 신청서' && currentUserData) {
    const form = document.getElementById('휴가 신청서');
    const vacationType = form.querySelector('[name="휴가형태"]').value;
    const vacationDays = parseFloat(form.querySelector('[name="휴가일수"]').value) || 0;
    if (vacationDays > 0) {
      if ((['연차', '오전 반차', '오후 반차'].includes(vacationType)) && vacationDays > currentUserData.남은연차) {
        alert(`연차 잔여일수가 부족합니다.`); return;
      }
      if (vacationType === '병가' && vacationDays > currentUserData.남은병가) {
        alert(`병가 잔여일수가 부족합니다.`); return;
      }
    }
  }

  let formData = { docType };
  document.querySelectorAll('#user-info-section .employee-data, #form-selection-section .employee-data, #isAddressChanged').forEach(input => {
    if (input.name) formData[input.name] = input.value || '';
  });
  const formContainer = document.getElementById(docType);
  if (formContainer) {
    formContainer.querySelectorAll('input, textarea, select').forEach(input => {
      if (input.name) formData[input.name] = input.value || '';
    });
  }
  if (!currentUserData?.성명) { alert("사용자 정보가 올바르지 않습니다."); return; }
  
  const submitButton = document.getElementById('submit-button');
  const loader = document.getElementById('loader');
  const statusEl = document.getElementById('status');
  loader.style.display = 'block';
  statusEl.textContent = '문서를 생성하고 있습니다...';
  submitButton.disabled = true;

  google.script.run
    .withSuccessHandler(function(response) {
      loader.style.display = 'none';
      submitButton.disabled = false;
      if (response.success) {
        statusEl.innerHTML = `<span class="info-message">✅ 문서가 성공적으로 생성되었습니다.</span>`;
        triggerPdfDownload(response.pdfBase64, response.fileName);
        if (docType === '휴가 신청서') {
          setTimeout(() => google.script.run.withSuccessHandler(res => {
            if (res.status === 'SUCCESS') populateFormWithUserData(res.data);
          }).getUserInfo(), 1000);
        }
      } else {
        statusEl.innerHTML = `<span class="warning-message">❌ 오류: ${response.message}</span>`;
        alert('문서 생성 중 오류 발생:\n' + response.message);
      }
    })
    .withFailureHandler(handleError)
    .createDocument(formData);
}

function triggerPdfDownload(base64Data, fileName) {
  try {
    const link = document.createElement('a');
    link.href = `data:application/pdf;base64,${base64Data}`;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } catch (e) {
    console.error("PDF 다운로드 오류:", e);
  }
}
</script>

FormReport.html

<div class="form-row">
  <label for="report-summary">1. 사건개요</label>
  <textarea id="report-summary" name="사건개요" rows="3"></textarea>
</div>
<div class="form-row">
  <label for="report-details">2. 사건 상세 내용</label>
  <textarea id="report-details" name="상세내용" rows="6"></textarea>
</div>
<div class="form-row">
  <label for="report-cause">3. 사건 발생 원인</label>
  <textarea id="report-cause" name="원인분석" rows="4"></textarea>
</div>
<div class="form-row">
  <label for="report-opinion">4. 향후 대책 및 본인 추가 의견</label>
  <textarea id="report-opinion" name="본인의견" rows="4"></textarea>
</div>
<div class="form-row">
  <label>신청일</label>
  <input type="date" name="신청일" class="default-today">
</div>

FormVacation.html

<div class="form-row">
  <label>휴가 기간</label>
  시작일: <input type="date" name="시작일" onchange="calculateDays('휴가 신청서', '시작일', '종료일', 'form4_휴가일수', '휴가일수')">
  종료일: <input type="date" name="종료일" onchange="calculateDays('휴가 신청서', '시작일', '종료일', 'form4_휴가일수', '휴가일수')">
  <span id="form4_휴가일수" class="calculated-field">0 일</span>
  <input type="hidden" name="휴가일수" value="0">
</div>
<div class="form-row">
  <label for="vac-type">휴가 형태</label>
  <select id="vac-type" name="휴가형태" onchange="toggleOtherField(this, 'form4_other_reason'); toggleReasonField(this, 'form4_reason_field'); showSickLeaveWarning(this);">
    <option value="연차">연차</option>
    <option value="오전 반차">오전 반차</option>
    <option value="오후 반차">오후 반차</option>
    <option value="경조사">경조사</option>
    <option value="병가">병가</option>
    <option value="공가">공가</option>
    <option value="기타">기타</option>
  </select>
</div>
<div id="sick-leave-warning" style="display: none; margin-top: 10px;"></div>
<div id="form4_other_reason" class="form-row" style="display: none;">
  <label>기타 사유</label>
  <input type="text" name="휴가형태_기타">
</div>
<div id="form4_reason_field" class="form-row" style="display: none;">
  <label>사유 (연차/반차 외)</label>
  <textarea name="사유" rows="3"></textarea>
</div>
<div id="vacation-warning" style="display: none; margin: 10px 0;"></div>
<div class="form-row">
  <label>전달사항 (업무 인수인계)</label>
  <textarea name="전달사항" rows="3"></textarea>
</div>
<div class="form-row">
  <label>비상연락처</label>
  <input type="text" name="비상연락처">
</div>
<div class="form-row">
  <label>신청일</label>
  <input type="date" name="신청일" class="default-today">
</div>

FormCertificate.html

<div class="form-row">
  <label>입사일 (자동 조회)</label>
  <input type="date" name="입사일" class="employee-data auto-filled" readonly>
</div>
<div class="form-row">
  <label>제출처 (용도)</label>
  <input type="text" name="제출처">
</div>
<div class="form-row">
  <label>신청일</label>
  <input type="date" name="신청일" class="default-today" onchange="calculateEmploymentPeriod()">
</div>
<div class="form-row">
  <label>재직기간:</label>
  <span class="calculated-field" id="form5_재직일">0년 0개월</span>
  <input type="hidden" name="재직일">
</div>

FormLeave.html

<div class="form-row">
  <label>휴직 기간</label>
  시작일: <input type="date" name="시작일" onchange="calculateDays('휴직계', '시작일', '종료일', 'form2_휴직일수', '휴직일수')">
  종료일: <input type="date" name="종료일" onchange="calculateDays('휴직계', '시작일', '종료일', 'form2_휴직일수', '휴직일수')">
  <span id="form2_휴직일수" class="calculated-field">0 일</span>
  <input type="hidden" name="휴직일수" value="0">
</div>
<div class="form-row">
  <label>휴직형태</label>
  <select name="휴직형태" onchange="toggleOtherField(this, 'form2_other_reason')">
    <option value="무급휴직">무급휴직</option>
    <option value="유급휴직">유급휴직</option>
    <option value="기타">기타</option>
  </select>
</div>
<div id="form2_other_reason" class="form-row" style="display: none;">
  <label>기타 사유</label>
  <input type="text" name="휴직형태_기타">
</div>
<div class="form-row">
  <label>휴직사유</label>
  <textarea name="휴직사유" rows="3"></textarea>
</div>
<div class="form-row">
  <label>전달사항</label>
  <textarea name="전달사항" rows="3"></textarea>
</div>
<div class="form-row">
  <label>신청일</label>
  <input type="date" name="신청일" class="default-today">
</div>

FormMaternity.html

<div class="form-row">
  <label>출산예정일</label>
  <input type="date" name="출산예정일">
</div>

<h4 class="sub-section-title">출산전후휴가</h4>
<div class="form-row">
  <label>시작일</label>
  <input type="date" name="출산휴가시작일" onchange="calculateDays('출산휴가 및 육아휴직 신청서', '출산휴가시작일', '출산휴가종료일', 'form3_휴가일수', '휴가일수')">
</div>
<div class="form-row">
  <label>종료일</label>
  <input type="date" name="출산휴가종료일" onchange="calculateDays('출산휴가 및 육아휴직 신청서', '출산휴가시작일', '출산휴가종료일', 'form3_휴가일수', '휴가일수')">
</div>
<div class="form-row">
  <label>휴가일수:</label>
  <span class="calculated-field" id="form3_휴가일수">0 일</span>
  <input type="hidden" name="휴가일수">
</div>

<h4 class="sub-section-title">육아휴직</h4>
<div class="form-row">
  <label>시작일</label>
  <input type="date" name="육아휴직시작일" onchange="calculateDays('출산휴가 및 육아휴직 신청서', '육아휴직시작일', '육아휴직종료일', 'form3_육아휴직일수', '육아휴직일수')">
</div>
<div class="form-row">
  <label>종료일</label>
  <input type="date" name="육아휴직종료일" onchange="calculateDays('출산휴가 및 육아휴직 신청서', '육아휴직시작일', '육아휴직종료일', 'form3_육아휴직일수', '육아휴직일수')">
</div>
<div class="form-row">
  <label>휴직일수:</label>
  <span class="calculated-field" id="form3_육아휴직일수">0 일</span>
  <input type="hidden" name="육아휴직일수">
</div>

<h4 class="sub-section-title">육아기 근로시간 단축</h4>
<div class="form-row">
  <label>시작일</label>
  <input type="date" name="육아기단축시작일" onchange="calculateDays('출산휴가 및 육아휴직 신청서', '육아기단축시작일', '육아기단축종료일', 'form3_육아기단축일수', '육아기단축일수')">
</div>
<div class="form-row">
  <label>종료일</label>
  <input type="date" name="육아기단축종료일" onchange="calculateDays('출산휴가 및 육아휴직 신청서', '육아기단축시작일', '육아기단축종료일', 'form3_육아기단축일수', '육아기단축일수')">
</div>
<div class="form-row">
  <label>단축일수:</label>
  <span class="calculated-field" id="form3_육아기단축일수">0 일</span>
  <input type="hidden" name="육아기단축일수">
</div>
<div class="form-row">
  <label>단축 후 근무 시작 시간</label>
  <input type="time" name="육아기근무시작시간" onchange="calculateHours('출산휴가 및 육아휴직 신청서', '육아기근무시작시간', '육아기근무종료시간', 'form3_육아기단축근무시간', '육아기단축근무시간')">
</div>
<div class="form-row">
  <label>단축 후 근무 종료 시간</label>
  <input type="time" name="육아기근무종료시간" onchange="calculateHours('출산휴가 및 육아휴직 신청서', '육아기근무시작시간', '육아기근무종료시간', 'form3_육아기단축근무시간', '육아기단축근무시간')">
</div>
<div class="form-row">
  <label>단축 근무시간:</label>
  <span class="calculated-field" id="form3_육아기단축근무시간">0 시간</span>
  <input type="hidden" name="육아기단축근무시간">
</div>

<h4 class="sub-section-title">전환형 시간 선택제 
  <button type="button" onclick="showInfoBox('form3_info_box')" style="margin-left: 10px; padding: 5px 10px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer;">제도안내 보기</button>
</h4>
<div class="info-box" id="form3_info_box" style="display: none;">
  <h4>'육아기 근로시간 단축' 제도 안내</h4>
  <p><b>대상:</b> 만 8세 이하 또는 초등학교 2학년 이하 자녀를 둔 직원<br>
  <b>기간:</b> 기본 1년 이내 (미사용 육아휴직 기간 가산 가능)<br>
  <b>근무시간:</b> 주 15시간 이상 ~ 35시간 이하<br>
  <b>분할 사용:</b> 가능 (1회 최소 3개월 이상)<br>
  <b>중요:</b> 근로시간 단축을 이유로 불리한 처우를 받지 않으며, 종료 후 원 직무로 복귀합니다.</p>
</div>
<div class="form-row">
  <label>시작일</label>
  <input type="date" name="전환형시작일">
</div>
<div class="form-row">
  <label>종료일</label>
  <input type="date" name="전환형종료일">
</div>
<div class="form-row">
  <label>비고</label>
  <textarea name="비고" rows="3"></textarea>
</div>
<div class="form-row">
  <label>신청일</label>
  <input type="date" name="신청일" class="default-today">
</div>